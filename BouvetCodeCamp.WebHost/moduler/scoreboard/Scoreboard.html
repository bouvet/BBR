<!DOCTYPE html>
<html>
    <head>
        <title>Bouvet Battle Royale - Scoreboard</title>

        <!-- Owl Carousel -->
        <link rel="stylesheet" href="js/vendors/owl-carousel/owl.carousel.css">
        <link rel="stylesheet" href="js/vendors/owl-carousel/owl.theme.css">

        <link rel="stylesheet" href="../bower_components/leaflet/dist/leaflet.css" />

        <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
        
        <link rel="stylesheet" href="css/scoreboard.css" />
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

        <script src="../bower_components/d3/d3.min.js"></script>
        <script src="../bower_components/hammerjs/hammer.min.js"></script>
        <script src="../bower_components/evispa-timo-jsclipper/clipper.js"></script>
        <script src="../bower_components/concavehull/dist/concavehull.js"></script>
        <script src="../bower_components/leaflet/dist/leaflet.js"></script>
        <script src="../bower_components/leaflet.freedraw/dist/leaflet.freedraw.js"></script>
        <script src="../bower_components/underscore/underscore.js"></script>

        <script src="http://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.1.0.min.js"></script>

        <script src="/signalr/hubs"></script>
        
        <script src="/moduler/scoreboard/js/scoreboard.infrastruktur.js"></script>
        <script src="/moduler/scoreboard/js/scoreboard.loader.js"></script>

        <!-- Owl Carousel -->
        <script src="js/vendors/owl-carousel/owl.carousel.js"></script>
        
        <script src="js/vendors/lodash-2.4.1/lodash.min.js"></script>
    </head>

    <body>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-1"></div>
                <div class="col-md-11"><img src="http://www.bouvet.no/Global/img/header_logo.png"></div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-1"></div>
                <div class="col-md-5"><div id="map"></div></div>
                <div class="col-md-5">
                    <div class="karusellwrapper">
                        <div class="owl-carousel">
                            <div class="stillingsvisning">
                                <section>
                                    <table class="stillingstabell">
                                        <caption>Stilling</caption>
                                        <thead>
                                            <tr>
                                                <th>Lag</th>
                                                <th>Poeng</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </section>
                            </div>
                            <div class="hendelservisning">
                                <section>
                                    <table class="hendelsestabell">
                                        <caption>Hendelser</caption>
                                        <thead>
                                            <tr>
                                                <th>Lag</th>
                                                <th>Hendelse</th>
                                                <th>Kommentar</th>
                                                <th>Tid</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-1"></div>
            </div>
        </div>
        
        <script type="text/javascript">
            'use strict';

            var map = null;
            var redMarkerIcon = null;
            
            $(function () {
                var mapElement = document.getElementById("map")
                    , latlng = [59.676403, 10.606424];

                map = L.map(mapElement).setView(latlng, 16);

                L.tileLayer('https://{s}.tiles.mapbox.com/v3/{id}/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    id: 'jorgenbs.jl9j4hbj'
                }).addTo(map);

                infrastruktur.sendAutentisertRequest("/api/admin/infisert/get", "GET", lastInnInfisertSone);
            
                //Extend the Default marker class
                var redIcon = L.Icon.Default.extend({
                    options: {
                        iconUrl: 'js/leaflet/custommarkers/marker-icon-red.png'
                    }
                });
                redMarkerIcon = new redIcon();
            });

            var map;
            var MaksAntallLoggHendelser = 20;

            var SCOREBOARD = SCOREBOARD || {};
            SCOREBOARD.Lag = [];
            SCOREBOARD.Poster = [];
            SCOREBOARD.LoggHendelser = [];
            SCOREBOARD.InfisertSone = {};
            
            // LAG
            function settLagPaaKartet() {
                $.each(SCOREBOARD.Lag, function (key, val) {
                    var sistePifPosisjonForLag = hentSistePifPosisjonForLag(val);

                    if (sistePifPosisjonForLag != null) {
                        SCOREBOARD.Lag[key].Marker = L.marker(
                            [sistePifPosisjonForLag.gps.latitude, sistePifPosisjonForLag.gps.longitude],
                            { icon: redMarkerIcon })
                            .addTo(map);
                    }
                });
            }
            function hentSistePifPosisjonForLag(lag) {
                if (typeof lag == "undefined" || typeof lag.pifPosisjoner == "undefined")
                    return null;

                lag.pifPosisjoner.sortBy(function (o) { return new Date(Date.parse(o.tid)); });

                return $(lag.pifPosisjoner).last()[0];
            }
            function sorterLagEtterPoeng() {
                return _.map(_.sortBy(SCOREBOARD.Lag, 'poeng'), _.values).reverse();
            }
            function lastInnLagene(data) {
                var a = 1;
                $.each(data, function (key, val) {
                    val.poeng = a;
                    SCOREBOARD.Lag.push(val);
                    SCOREBOARD.Lag[key].Marker = {};
                    a++;
                });
                
                oppdaterStillingstabell();

                settLagPaaKartet();
            }
            //http://stackoverflow.com/questions/10123953/sort-javascript-object-array-by-date
            (function () {
                if (typeof Object.defineProperty === 'function') {
                    try { Object.defineProperty(Array.prototype, 'sortBy', { value: sb }); } catch (e) { }
                }
                if (!Array.prototype.sortBy) Array.prototype.sortBy = sb;

                function sb(f) {
                    for (var i = this.length; i;) {
                        var o = this[--i];
                        this[i] = [].concat(f.call(o, o, i), o);
                    }
                    this.sort(function (a, b) {
                        for (var i = 0, len = a.length; i < len; ++i) {
                            if (a[i] != b[i]) return a[i] < b[i] ? -1 : 1;
                        }
                        return 0;
                    });
                    for (var i = this.length; i;) {
                        this[--i] = this[i][this[i].length - 1];
                    }
                    return this;
                }
            })();

            // INFISERT SONE
            function lastInnInfisertSone(data) {
                try {

                    if ($.isEmptyObject(SCOREBOARD.InfisertSone)) {
                        //SCOREBOARD.InfisertSone = data;
                    }
                    else {
                        if (typeof SCOREBOARD.InfisertSone != "undefined") {
                            map.removeLayer(SCOREBOARD.InfisertSone);
                        }
                    }

                    SCOREBOARD.InfisertSone = new L.Polygon(mapToLeafletModel(data.koordinater));
                    
                    map.addLayer(SCOREBOARD.InfisertSone);
                } catch (e) {
                    console.log('Laste inn infisert sone feilet: ' + e.Message);
                }
            }
            function mapToLeafletModel(koordianter) {
                var modelArray = [];
                _.each(koordianter, function (latlng) {

                    var obj = {
                        "lat": latlng.latitude,
                        "lng": latlng.longitude
                    };

                    modelArray.push(obj);

                });

                return modelArray;
            };

            // POSTER
            function lastInnPoster(data) {
                $.each(data, function (key, val) {
                    SCOREBOARD.Poster.push(val);
                    SCOREBOARD.Poster[key].Marker = {};
                });

                settPosterPaaKartet();
            }
            function settPosterPaaKartet() {
                $.each(SCOREBOARD.Poster, function (key, val) {
                    SCOREBOARD.Poster[key].Marker = L.marker([val.gps.latitude, val.gps.longitude]).addTo(map);
                });
            }

            function oppdaterStillingstabell() {
                $('.stillingstabell > tbody').html("");

                var sortertLagListe = sorterLagEtterPoeng();

                $.each(sortertLagListe, function (index) {
                    var lag = hentLagEtterLagId(sortertLagListe[index][0])[0];

                    $('.stillingstabell').find('tbody:last').append('<tr><td>' + lag.lagnummer + '</td><td>' + lag.poeng + '</td></tr>');
                });
            }

            function oppdaterHendelsestabell() {
                $('.hendelsestabell > tbody').html("");

                $.each(SCOREBOARD.LoggHendelser, function (index, value) {
                    $('.hendelsestabell').find('tbody:last').append(
                        '<tr><td>' + value.lagId +
                        '</td><td>' + value.hendelse +
                        '</td><td>' + value.kommentar +
                        '</td><td>' + value.tid +
                        '</td></tr>');
                });
            }

            $(document).ready(function () {

                loader.lastInnLag(lastInnLagene);

                loader.lastInnPoster(lastInnPoster);

                loader.lastInnInfisertSone(lastInnInfisertSone);

                $(".owl-carousel").owlCarousel({
                    autoPlay: true,
                    loop: true,
                    slideSpeed: 300,
                    paginationSpeed: 400,
                    singleItem: true,
                    autoplayHoverPause: true,
                    margin: 10,
                    autoHeight: true
                });
            });
            
            $(function () {
                //Set the hubs URL for the connection
                $.connection.hub.url = "/signalr";

                // Declare a proxy to reference the hub.
                var hub = $.connection.gameHub;

                hub.client.settInfisertSone = function (infisertSone) {

                    lastInnInfisertSone(infisertSone);

                };

                // Create a function that the hub can call to broadcast messages.
                hub.client.nyPifPosisjon = function (msg) {
                    var lag = hentLagEtterLagId(msg.lagId);

                    var nyLeafletLatLon = new L.LatLng(msg.latitude, msg.longitude);

                    if (typeof lag[0].Marker == "undefined"
                        || lag[0].Marker == null
                        || $.isEmptyObject(lag[0].Marker)) {
                        lag[0].Marker = L.marker(
                            [nyLeafletLatLon.lat, nyLeafletLatLon.lng],
                            { icon: redMarkerIcon })
                            .addTo(map);
                    } else {
                        lag[0].Marker.setLatLng(nyLeafletLatLon);
                    }
                };

                // Ny logghendelse
                hub.client.nyLoggHendelse = function (msg) {
                    LeggTilNyLoggHendelse(msg);
                }

                // Start the connection.
                $.connection.hub.start({ jsonp: true });
            });

            function hentLagEtterLagId(lagId) {
                return $.grep(SCOREBOARD.Lag, function (n, i) {
                    return n.lagId == lagId;
                });
            }

            function LeggTilNyLoggHendelse(elem) {

                if (elem.hendelsetype == "RegistrertPifPosisjon")
                    return;

                SCOREBOARD.LoggHendelser.unshift(elem);

                if (SCOREBOARD.LoggHendelser.length > MaksAntallLoggHendelser)
                    SCOREBOARD.LoggHendelser.pop();

                oppdaterHendelsestabell();
            }

        </script>

    </body>
</html>