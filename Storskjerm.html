<!DOCTYPE html>
<html>
<head>
    <style>
        #map_canvas {
            width: 400px;
            height: 900px;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="http://ajax.aspnetcdn.com/ajax/signalr/jquery.signalr-2.1.0.min.js"></script>
    <script src="http://localhost:2014/signalr/hubs"></script>
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">

    <script>
        var baseApiAddress = "bouvetcodecamp";
        var map;
        function initialize() {
            var mapCanvas = document.getElementById('map_canvas');
            var mapOptions = {
                center: new google.maps.LatLng(59.676403, 10.606424),
                zoom: 16,
                disableDefaultUI: true,
                mapTypeId: google.maps.MapTypeId.SATELLITE
            }
            map = new google.maps.Map(mapCanvas, mapOptions);
            google.maps.event.addListener(map, 'rightclick', function (event) {
                var lat = event.latLng.lat();
                var lng = event.latLng.lng();
                $("#lat").val(lat);
                $("#long").val(lng);

            });

        }
        google.maps.event.addDomListener(window, 'load', initialize);
        var lag = {};
        lag.Lag = [];
        $(document).ready(function () {
            $.getJSON("http://" + baseApiAddress + "/api/game/pif/get", function (data) {
                $.each(data, function (key, val) {
                    lag[val.lagId] = createMarker(val.latitude, val.longitude, val.lagId);
                });
            });

            $("#makeRedZone").click(function () {
                $.getJSON("http://" + baseApiAddress + "/api/game/setRedZone?latitude=" + $("#lat").val() + "&longitude=" + $("#long").val());
            });

            $("#moveTeam").click(function () {
                $.getJSON("http://" + baseApiAddress + "/api/game/pif/put?Latitude=" + $("#lat").val() + "&Longitude=" + $("#long").val() + "&LagId=" + $("#lag").val());
            });

            $("#removeRedZone").click(function () {
                $.getJSON("http://" + baseApiAddress + "/api/game/setRedZone?latitude=" + "0" + "&longitude=" + "0");
            });
        });


        function createMarker(latitude, longitude, lagid) {
            return new google.maps.Marker({
                position: new google.maps.LatLng(latitude, longitude),
                map: map,
                icon: 'http://chart.apis.google.com/chart?chst=d_map_pin_letter&chld=' + lagid + '|FE6256|000000'
            });
        }
        var infectedZone;
        function redZone(lat, long, size) {
            var options = {
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                map: map,
                center: new google.maps.LatLng(lat, long),
                radius: Math.sqrt(size) * 100
            };
            // Add the circle for this city to the map.
            infectedZone = new google.maps.Circle(options);
        }
        redZone(0, 0, 2);
    </script>
    <script type="text/javascript">
        $(function () {
            //Set the hubs URL for the connection
            $.connection.hub.url = "http://" + baseApiAddress + "/signalr";

            // Declare a proxy to reference the hub.
            var hub = $.connection.gameHub;
            hub.client.setRedZone = function (zone) {
                if (zone.latitude == 0 && zone.longitude == 0) {
                    infectedZone.setMap(null);
                } else {                   
                    var newPosition = new google.maps.LatLng(zone.latitude, zone.longitude);                  
                    var options = {
                      
                        fillColor: '#00FF00',
                        center: newPosition,
                        map: map
                    };
                    infectedZone.setOptions(options);
                    setTimeout(function () {
                        var options = {

                            fillColor: '#FF0000'
                        }; infectedZone.setOptions(options);
                    },30000)
                }

            };
            // Create a function that the hub can call to broadcast messages.
            hub.client.nyPifPosisjon = function (msg) {
                if (lag[msg.LagId] === undefined) {


                    lag[msg.LagId] = createMarker(msg.Latitude, msg.Longitude, msg.LagId);
                } else {

                    lag[msg.LagId].setPosition(new google.maps.LatLng(msg.Latitude, msg.Longitude));
                }
            };
            // Start the connection.
            $.connection.hub.start({ jsonp: true });//
        });
    </script>




</head>
<body>
    <div class="row">
        <div class="col-md-1"></div>
        <div class="col-md-11"><img src="http://www.bouvet.no/Global/img/header_logo.png"></div>
        </div>
        <div class="row">
            <div class="col-md-1"></div>
            <div class="col-md-3"><div id="map_canvas"></div></div>
            <div class="col-md-3">
                <div>Stilling</div>
                <div>Lag 3 56 poeng</div>                  
                <div>Lag 3 56 poeng</div>   
                <div>Lag 3 56 poeng</div>   
                <div>Lag 3 56 poeng</div>   
                <div>Lag 3 56 poeng</div>   
                <div>Lag 3 56 poeng</div>   
                <div>Lag 3 56 poeng</div>                 
            </div>
            <div class="col-md-4">
                <div>
                    <label for="lat">Lat</label><input type="number" id="lat" />
                    <label for="long">Long</label><input type="number" id="long" />
                    <label for="lag">Lag</label><input type="number" id="lag" />
                    <button id="makeRedZone">Lag infisert sone</button>
                    <button id="moveTeam">Flytt lag hit</button>
                    <button id="removeRedZone">Fjern infisert sone</button>
                </div>
            </div>
            <div class="col-md-3"></div>

        </div>





</body>
</html>